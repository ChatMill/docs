# Miss Spec 错误码与异常场景说明

## 1. 业务异常与冲突场景总汇

### 1.1 与会人管理相关
- 添加与会人时，目标用户并不在当前 channel/guild 中
  - 推荐提示语：`用户不在当前频道，无法添加为与会人。`
- 移除与会人时，目标用户本就不在与会人列表
  - 推荐提示语：`用户不在与会人列表，无需移除。`
- 与会人全部被移除
  - 推荐提示语：`至少保留一名与会人，无法全部移除。`

### 1.2 责任人相关
- 添加责任人时，目标用户不是与会人
  - 推荐提示语：`责任人必须是与会人，请先添加为与会人。`
- 移除责任人时，目标用户本就不是责任人
  - 推荐提示语：`用户不是责任人，无需移除。`

### 1.3 手动修改相关
- patch 路径不存在或类型不符
  - 推荐提示语：`指定路径不存在或类型不符，修改失败。`
- full 替换时结构不合法
  - 推荐提示语：`新任务结构不合法，替换失败。`
- 修改 sub_task 时 missspec_id 冲突或丢失
  - 推荐提示语：`子任务 ID 冲突或缺失，无法替换。`

### 1.4 事件操作权限
- 非与会人尝试补充、确认、手动修改
  - 推荐提示语：`仅与会人可进行此操作。`

### 1.5 需求流转边界
- 重复确认/补充/发布
  - 推荐提示语：`该操作已完成，无需重复提交。`
- 补充响应时 session 已关闭
  - 推荐提示语：`会话已关闭，无法补充。`

### 1.6 消息/任务溯源
- history 中 message_id 不存在或已被删除
  - 推荐提示语：`历史消息不存在，部分溯源失败。`

### 1.7 平台/集成相关
- 同步到下游平台失败（如 GitHub API 限流/权限不足）
  - 推荐提示语：`下游平台同步失败，请稍后重试或联系管理员。`
- 下游平台（如 GitHub、Notion）API 限流、超时、服务不可用
  - 推荐提示语：`下游平台暂时不可用，请稍后重试。`
- 下游平台权限不足（如机器人未授权、token 失效）
  - 推荐提示语：`下游平台权限不足，请联系管理员重新授权。`
- 下游平台对象不存在（如 issue、project、repo 被删除）
  - 推荐提示语：`下游平台目标对象不存在或已被删除。`
- 下游平台字段/格式不兼容（如 title/description 超长、特殊字符）
  - 推荐提示语：`部分内容未能同步，字段超限或包含不支持字符。`
- 下游平台 webhook 回调失败
  - 推荐提示语：`下游平台回调失败，请检查 webhook 配置。`
- 多平台同步时部分平台成功、部分失败
  - 推荐提示语：`部分平台同步失败，请检查各平台状态。`
- 平台集成版本不兼容或 API 变更
  - 推荐提示语：`下游平台接口变更，请联系管理员适配新版本。`

### 1.8 用户输入与命令语法相关异常
- session_id 输入错误/不存在
  - 推荐提示语：`未找到对应会话，请检查 session_id 是否正确。`
- organization_id/project_id 不匹配
  - 推荐提示语：`会话与当前频道/服务器不匹配。`
- 命令语法错误
  - 推荐提示语：`未知命令，请检查语法或输入 /missspec help 查看用法。`
- 参数分隔符错误
  - 推荐提示语：`消息区间格式错误，正确格式如 12..15 或 12,14,15。`
- 命令缺少必填参数
  - 推荐提示语：`命令缺少必填参数，请输入 /missspec help 查看用法。`
- 参数顺序错误或多余参数
  - 推荐提示语：`命令参数顺序或数量有误，请输入 /missspec help 查看正确用法。`
- @用户格式错误或用户不存在
  - 推荐提示语：`请使用 @用户名 格式，并确保用户存在。`
- 消息区间格式错误
  - 推荐提示语：`消息区间格式错误，正确格式如 12..15 或 12,14,15。`
- 参数类型错误
  - 推荐提示语：`参数类型错误，请检查消息ID等参数格式。`
- 命令大小写混用或拼写错误
  - 推荐提示语：`命令区分大小写，请使用 /missspec initiate 等标准格式。`
- session_id、message_id、user_id 等 ID 格式非法
  - 推荐提示语：`ID 格式非法，请检查输入内容。`
- 命令过长或参数超出限制
  - 推荐提示语：`命令参数过多，请分批操作。`
- 命令中包含敏感词或非法字符
  - 推荐提示语：`命令中包含非法字符，请重新输入。`
- 命令在不支持的频道/私聊中使用
  - 推荐提示语：`该命令仅支持在指定频道/群组中使用。`
- 命令冷却时间未到（防刷屏/限流）
  - 推荐提示语：`操作过于频繁，请稍后再试。`
- 命令与当前会话状态冲突
  - 推荐提示语：`当前会话状态不支持此操作。`
- 消息区间过长（如 /missspec initiate 1..100）
  - 推荐提示语：`一次性添加的消息区间不能超过25条，请缩小范围或分批操作。`

### 1.9 消息内容类型相关
- 仅支持纯文本消息，遇到图片、文件、表情等非文本消息时：
  - 推荐提示语：`仅支持纯文本消息，图片、文件、表情等暂不支持。`

## 2. 校验点与异常责任分层（摘自 DEV_GUIDE.md）

- **interfaces**：输入解析、基础格式/平台校验（如命令格式、ID、@user、GUILD_IDS、webhook来源等）
- **application**：业务流程、权限、上下文复杂校验（如区间上限、参与人/责任人、session状态等）
- **domain**：领域不变式、数据一致性校验（如session参与人、事件树、发布后不可补充等）

### 2.1 典型异常类
- PermissionDenied
- InvalidCommand

> 详细异常与提示语请结合 INTERACTION_GUIDE.md 第5章与 DEV_GUIDE.md 校验节点说明查阅。
